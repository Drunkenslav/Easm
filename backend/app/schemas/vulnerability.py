"""
Pydantic schemas for Vulnerability model
"""
from typing import Optional, List, Dict, Any
from pydantic import BaseModel, Field
from app.models.enums import VulnerabilityState, VulnerabilitySeverity
from app.schemas.base import TimestampSchema


class VulnerabilityBase(BaseModel):
    """Base vulnerability schema"""
    template_id: str = Field(..., max_length=255)
    template_name: Optional[str] = Field(None, max_length=500)
    name: str = Field(..., max_length=500)
    description: Optional[str] = None
    severity: VulnerabilitySeverity
    matched_at: str = Field(..., max_length=1000)
    tags: List[str] = []
    cve_ids: List[str] = []
    cwe_ids: List[str] = []
    cvss_score: Optional[str] = None
    reference_urls: List[str] = []


class VulnerabilityCreate(VulnerabilityBase):
    """Schema for creating a vulnerability"""
    asset_id: int
    scan_id: int
    extracted_results: List[Any] = []
    request: Optional[str] = None
    response: Optional[str] = None
    curl_command: Optional[str] = None
    template_metadata: Dict[str, Any] = {}


class VulnerabilityUpdate(BaseModel):
    """Schema for updating a vulnerability"""
    state: Optional[VulnerabilityState] = None
    assigned_to_user_id: Optional[int] = None
    resolution_notes: Optional[str] = None
    is_risk_accepted: Optional[bool] = None
    risk_acceptance_reason: Optional[str] = None


class VulnerabilityStateChange(BaseModel):
    """Schema for changing vulnerability state"""
    state: VulnerabilityState
    notes: Optional[str] = None


class VulnerabilityAssignment(BaseModel):
    """Schema for assigning vulnerability"""
    assigned_to_user_id: int


class VulnerabilityInDB(VulnerabilityBase, TimestampSchema):
    """Schema for vulnerability in database"""
    id: int
    asset_id: int
    scan_id: int
    tenant_id: Optional[str] = None
    state: VulnerabilityState
    extracted_results: List[Any] = []
    request: Optional[str] = None
    response: Optional[str] = None
    curl_command: Optional[str] = None
    template_metadata: Dict[str, Any] = {}
    template_path: Optional[str] = None
    state_changed_at: Optional[str] = None
    state_changed_by_user_id: Optional[int] = None
    assigned_to_user_id: Optional[int] = None
    assigned_at: Optional[str] = None
    resolution_notes: Optional[str] = None
    resolved_at: Optional[str] = None
    resolved_by_user_id: Optional[int] = None
    hash: Optional[str] = None
    first_seen_at: Optional[str] = None
    last_seen_at: Optional[str] = None
    occurrences: int = 1
    is_risk_accepted: bool = False
    risk_acceptance_reason: Optional[str] = None
    risk_accepted_by_user_id: Optional[int] = None
    risk_accepted_at: Optional[str] = None


class Vulnerability(VulnerabilityInDB):
    """Public vulnerability schema"""
    pass


class VulnerabilityWithAsset(Vulnerability):
    """Vulnerability schema with asset information"""
    asset_type: str
    asset_value: str
    asset_name: Optional[str] = None


class VulnerabilityStats(BaseModel):
    """Vulnerability statistics"""
    total: int = 0
    by_severity: Dict[str, int] = {}
    by_state: Dict[str, int] = {}
    by_asset: Dict[int, int] = {}
    open_count: int = 0
    resolved_count: int = 0
